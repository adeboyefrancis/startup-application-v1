name: Deployment of EC2 Instance with Custom AMI

on:
  workflow_dispatch: 
    inputs: 
        ami_version:
            description: "Custom AMI version"
            required: true

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  TF_CLOUD_API_TOKEN: ${{ secrets.TF_CLOUD_API_TOKEN }}

jobs:
    ec2_deploy:
        runs-on: ubuntu-latest
        defaults:
             run:
              working-directory: terraform

        outputs: 
            webapp_public_ip: ${{ steps.tf_out.outputs.ec2_ip }}

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: "1.9.8"
                cli_config_credentials_token: ${{ secrets.TF_CLOUD_API_TOKEN }}

            - name: Terraform Init
              id: init
              run: terraform init

            - name: Terraform Format Check
              id: fmt
              run: terraform fmt

            - name: Terraform Validate
              id: validate
              run: terraform validate -no-color

            - name: Terraform Plan
              id: plan
              run: terraform plan -var 'custom_ami_version=${{ inputs.ami_version }}' -no-color
              continue-on-error: true

            - name: Terraform Apply
              id: apply
              run: terraform apply -var 'custom_ami_version=${{ inputs.ami_version }}' -auto-approve

            - name: Terraform Outputs
              id: tf_out
              run: |
                echo "ec2_ip=$(terraform output webapp_public_ip | tr -d '""')" >> "$GITHUB_OUTPUT"

            - name: Verify EC2 Deployment
              run: |
                ip=$(terraform output webapp_public_ip)
                curl -f http://$ip || exit 1
                if curl -f http://$ip; then
                  echo "Deployment successful! EC2 instance is accessible at http://$ip"
                else
                  echo "Deployment verification failed"
                  exit 1
                fi
